<!DOCTYPE html>
<html>
<head>
    <title>Purdue Bell Tower</title>
    <style>
        :root { --p-gold: #CEB888; --iu-red: #990000; --bg: #0b0b0b; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
        
        /* THE LOBBY YOU LIKED */
        #setup-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .card { background: #111; padding: 30px; border: 2px solid var(--p-gold); border-radius: 8px; width: 320px; text-align: center; }
        input { padding: 10px; margin: 5px; width: 85%; background: #000; color: white; border: 1px solid #444; }
        .btn { padding: 10px 20px; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; }
        .btn-gold { background: var(--p-gold); color: black; }
        
        /* SIDEBAR & GAME */
        #sidebar { width: 280px; background: #000; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #chat-history { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.85rem; background: #050505; }
        #game-area { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .track { display: flex; gap: 10px; margin: 15px 0; }
        .slot { width: 80px; height: 110px; border: 1px dashed #444; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .filled-construction { background: var(--iu-red); border-style: solid; }
        .filled-tradition { background: var(--p-gold); color: black; border-style: solid; }
        
        #vote-overlay, #policy-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .p-card { width: 100px; height: 140px; margin: 10px; border-radius: 5px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="card" id="start-card">
            <h2 style="color:var(--p-gold)">THE BELL TOWER</h2>
            <input id="user-name" placeholder="Name">
            <button class="btn btn-gold" onclick="socket.emit('createRoom', document.getElementById('user-name').value)">Create Room</button>
            <input id="room-code-input" placeholder="Room Code">
            <button class="btn" style="background:#333; color:white" onclick="socket.emit('joinRoom', {roomCode: document.getElementById('room-code-input').value, userName: document.getElementById('user-name').value})">Join Room</button>
        </div>
        <div class="card" id="lobby-card" style="display:none">
            <h3 id="room-display" style="color:var(--p-gold)"></h3>
            <div id="lobby-players" style="text-align:left; margin:15px 0"></div>
            <button id="host-btn" class="btn btn-gold" style="display:none" onclick="socket.emit('startGame')">Start Game</button>
        </div>
    </div>

    <div id="sidebar">
        <div id="player-list" style="padding:10px; border-bottom:1px solid #222"></div>
        <div id="chat-history"></div>
        <input id="chat-msg" placeholder="Chat..." onkeydown="if(event.key==='Enter') sendChat()">
        <div style="padding:15px; border-top:1px solid var(--p-gold)">
            <p id="id-text">Role: Hidden</p>
            <button class="btn btn-gold" style="width:100%" onmousedown="rev(true)" onmouseup="rev(false)">REVEAL ROLE</button>
        </div>
    </div>

    <div id="game-area">
        <div id="status" style="border:1px solid var(--p-gold); padding:10px; border-radius:20px; margin-bottom:20px">Lobby</div>
        <div><h5>TRADITION</h5><div class="track" id="t-track"></div></div>
        <div><h5>CONSTRUCTION</h5><div class="track" id="c-track"></div></div>
        
        <div id="nom-zone" style="display:none; margin-top:20px">
            <select id="vp-sel" style="padding:10px; background:#000; color:white"></select>
            <button class="btn btn-gold" onclick="nominate()">Nominate VP</button>
        </div>
        <button id="draw-btn" class="btn btn-gold" style="display:none" onclick="socket.emit('drawThree')">Draw 3 Cards</button>
    </div>

    <div id="vote-overlay">
        <h2 id="v-prompt"></h2>
        <button class="btn btn-gold" onclick="cast('Boiler Up!')">Boiler Up!</button>
        <button class="btn" style="background:var(--iu-red); color:white" onclick="cast('Hammer Down!')">Hammer Down!</button>
    </div>

    <div id="policy-overlay">
        <h2 id="p-prompt"></h2>
        <div id="p-choices" style="display:flex"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRole = "";

        socket.on('joinedRoom', d => {
            document.getElementById('start-card').style.display='none';
            document.getElementById('lobby-card').style.display='block';
            document.getElementById('room-display').innerText = "CODE: " + d.roomCode;
            if(d.isHost) document.getElementById('host-btn').style.display='block';
        });

        socket.on('updatePlayerList', pl => {
            const list = pl.map(p => `<div>${p.name}</div>`).join('');
            document.getElementById('lobby-players').innerHTML = list;
            document.getElementById('player-list').innerHTML = list;
        });

        socket.on('assignRole', d => { myRole = d.role; });
        function rev(s) { document.getElementById('id-text').innerText = s ? myRole : "Role: Hidden"; }

        socket.on('gameStarted', () => document.getElementById('setup-screen').style.display='none');

        socket.on('newRound', d => {
            document.getElementById('status').innerText = "President: " + d.presidentName;
            if(socket.id === d.presidentId) {
                document.getElementById('nom-zone').style.display='block';
                document.getElementById('vp-sel').innerHTML = d.players
                    .filter(p => p.id !== socket.id)
                    .map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            } else {
                document.getElementById('nom-zone').style.display='none';
            }
        });

        function nominate() {
            socket.emit('nominateVP', document.getElementById('vp-sel').value);
            document.getElementById('nom-zone').style.display='none';
        }

        socket.on('startVoting', d => {
            document.getElementById('v-prompt').innerText = `Elect ${d.vp}?`;
            document.getElementById('vote-overlay').style.display='flex';
        });

        function cast(v) { 
            socket.emit('submitVote', v); 
            document.getElementById('vote-overlay').style.display='none'; 
        }

        socket.on('chatMessage', d => {
            const h = document.getElementById('chat-history');
            const m = document.createElement('div');
            m.style.color = d.color || 'white';
            m.innerHTML = `<b>${d.user}:</b> ${d.msg}`;
            h.appendChild(m); h.scrollTop = h.scrollHeight;
        });

        socket.on('policyUpdated', d => {
            const tt = document.getElementById('t-track'); tt.innerHTML = '';
            for(let i=1; i<=5; i++) tt.innerHTML += `<div class="slot ${i<=d.enactedPolicies.tradition?'filled-tradition':''}">T</div>`;
            const ct = document.getElementById('c-track'); ct.innerHTML = '';
            for(let i=1; i<=6; i++) ct.innerHTML += `<div class="slot ${i<=d.enactedPolicies.construction?'filled-construction':''}">C</div>`;
        });

        socket.on('presDrawPhase', () => document.getElementById('draw-btn').style.display='block');
        socket.on('presDiscardPhase', h => showP(h, true));
        socket.on('vpEnactPhase', d => showP(d.cards, false));

        function showP(cards, isP) {
            document.getElementById('p-prompt').innerText = isP ? "President: Discard 1" : "VP: Enact 1";
            document.getElementById('p-choices').innerHTML = cards.map((c,i) => `
                <div class="p-card ${c==='Tradition'?'filled-tradition':'filled-construction'}" onclick="choose(${isP},'${c}',${i},${JSON.stringify(cards)})">${c}</div>
            `).join('');
            document.getElementById('policy-overlay').style.display='flex';
            document.getElementById('draw-btn').style.display='none';
        }

        function choose(isP, c, i, h) {
            document.getElementById('policy-overlay').style.display='none';
            if(isP) { h.splice(i,1); socket.emit('presDiscard', h); }
            else socket.emit('vpEnact', c);
        }

        function sendChat() {
            const i = document.getElementById('chat-msg');
            if(i.value) { socket.emit('sendChat', i.value); i.value=''; }
        }
        socket.on('errorMsg', m => alert(m));
    </script>
</body>
</html>