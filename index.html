<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Under the Bell Tower | Purdue Edition</title>
    <style>
        :root { --p-gold: #CEB888; --iu-red: #990000; --bg: #0b0b0b; --success: #00FF00; --fail: #FF0000; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Setup & Lobby Screens */
        #setup-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .card { background: #111; padding: 30px; border: 2px solid var(--p-gold); border-radius: 8px; width: 320px; text-align: center; box-shadow: 0 0 20px rgba(206, 184, 136, 0.2); }
        input { padding: 12px; margin: 8px 0; width: 90%; background: #000; color: white; border: 1px solid #444; border-radius: 4px; }
        .btn { padding: 10px 20px; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .btn-gold { background: var(--p-gold); color: black; }
        .btn-gold:hover { background: #e2cc9d; }

        /* Game Layout */
        #sidebar { width: 300px; background: #000; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #player-list { flex: 1; padding: 15px; overflow-y: auto; }
        #chat-container { flex: 1; display: flex; flex-direction: column; border-top: 1px solid #222; }
        #chat-history { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.9rem; background: #050505; }
        .chat-msg { margin-bottom: 5px; line-height: 1.4; }

        #game-area { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .track-container { background: #111; padding: 15px; border-radius: 8px; width: 95%; border: 1px solid #222; margin-bottom: 25px; }
        .track { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .slot { width: 85px; height: 120px; border: 1px dashed #444; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: bold; text-align: center; }
        .filled-construction { background: var(--iu-red); color: white; border-style: solid; }
        .filled-tradition { background: var(--p-gold); color: black; border-style: solid; }
        .power-tag { position: absolute; bottom: -22px; color: var(--p-gold); font-size: 0.55rem; text-transform: uppercase; }

        /* Overlays */
        #overlay, #vote-overlay, #policy-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .policy-card { width: 120px; height: 175px; margin: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); }
        
        .player-tag { padding: 6px; margin: 4px 0; background: #151515; border-left: 4px solid #333; border-radius: 2px; }
        .is-pres { border-left-color: var(--p-gold); background: #221f18; }
        .is-dead { opacity: 0.3; text-decoration: line-through; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="card" id="start-card">
            <h1 style="color: var(--p-gold); margin-top: 0;">BELL TOWER</h1>
            <input id="user-name" placeholder="Enter Your Name">
            <button class="btn btn-gold" style="width: 100%;" onclick="createRoom()">Create New Room</button>
            <div style="margin: 15px 0; opacity: 0.5;">â€” OR â€”</div>
            <input id="room-input" placeholder="Enter 5-Letter Code">
            <button class="btn" style="width: 100%; background: #333; color: white;" onclick="joinRoom()">Join Room</button>
        </div>

        <div class="card" id="lobby-card" style="display:none">
            <h2 id="room-display" style="color: var(--p-gold);"></h2>
            <div id="lobby-players" style="text-align: left; margin: 20px 0; min-height: 100px;"></div>
            <button id="host-start-btn" class="btn btn-gold" style="display:none; width: 100%;" onclick="socket.emit('startGame')">Start Semester</button>
            <p id="wait-msg" style="font-size: 0.8rem; color: #888;">Waiting for more students (5+)...</p>
        </div>
    </div>

    <div id="sidebar">
        <div id="player-list"></div>
        <div id="chat-container">
            <div id="chat-history"></div>
            <input id="chat-msg" placeholder="Type a message..." onkeydown="if(event.key==='Enter') sendChat()">
        </div>
        <div style="padding: 15px; background: #111; border-top: 1px solid var(--p-gold);">
            <p id="id-text" style="font-size: 0.75rem; color: #888; margin-top: 0;">Identity: [Hidden]</p>
            <button class="btn btn-gold" style="width: 100%;" onmousedown="reveal(true)" onmouseup="reveal(false)" ontouchstart="reveal(true)" ontouchend="reveal(false)">HOLD TO REVEAL</button>
        </div>
    </div>

    <div id="game-area">
        <div id="status-bar" style="background: #1a1a1a; padding: 10px 30px; border-radius: 30px; border: 1px solid var(--p-gold); margin-bottom: 25px; font-weight: bold;">Waiting for players...</div>
        
        <div class="track-container">
            <h4 style="margin: 0; color: var(--p-gold);">TRADITION (Boilermakers)</h4>
            <div class="track" id="tradition-track"></div>
        </div>

        <div class="track-container">
            <h4 style="margin: 0; color: var(--iu-red);">CONSTRUCTION (Hoosiers)</h4>
            <div class="track" id="construction-track"></div>
        </div>

        <div id="nomination-zone" style="display:none; text-align: center; background: #111; padding: 20px; border-radius: 8px; border: 1px solid var(--p-gold);">
            <h3>Presidential Turn: Nominate a VP</h3>
            <select id="vp-select" style="padding: 10px; background: #000; color: white; border: 1px solid var(--p-gold); width: 200px;"></select>
            <button class="btn btn-gold" onclick="nominate()">Nominate</button>
        </div>

        <button id="draw-btn" class="btn btn-gold" style="display:none; margin-top: 20px; padding: 20px 40px;" onclick="socket.emit('drawThree')">DRAW 3 POLICIES</button>
    </div>

    <div id="vote-overlay">
        <h2 id="vote-prompt"></h2>
        <div style="display: flex; gap: 20px;">
            <button class="btn" style="background: var(--success); color: black; padding: 20px 40px;" onclick="castVote('Boiler Up!')">BOILER UP! (Yes)</button>
            <button class="btn" style="background: var(--fail); color: white; padding: 20px 40px;" onclick="castVote('Hammer Down!')">HAMMER DOWN! (No)</button>
        </div>
    </div>

    <div id="policy-overlay">
        <h2 id="policy-prompt"></h2>
        <div id="policy-choices" style="display: flex;"></div>
    </div>

    <div id="overlay">
        <h2 id="overlay-title"></h2>
        <div id="overlay-content"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName = "";
        let amHost = false;
        let players = [];

        // Room Management
        function createRoom() {
            myName = document.getElementById('user-name').value.trim();
            if (myName) socket.emit('createRoom', myName);
        }

        function joinRoom() {
            myName = document.getElementById('user-name').value.trim();
            const code = document.getElementById('room-input').value.trim().toUpperCase();
            if (myName && code) socket.emit('joinRoom', { roomCode: code, userName: myName });
        }

        socket.on('joinedRoom', d => {
            amHost = d.isHost;
            document.getElementById('setup-screen').style.display = 'none';
            if (!amHost) {
                document.getElementById('setup-screen').style.display = 'flex';
                document.getElementById('start-card').style.display = 'none';
                document.getElementById('lobby-card').style.display = 'block';
                document.getElementById('room-display').innerText = `ROOM: ${d.roomCode}`;
            } else {
                document.getElementById('setup-screen').style.display = 'flex';
                document.getElementById('start-card').style.display = 'none';
                document.getElementById('lobby-card').style.display = 'block';
                document.getElementById('room-display').innerText = `ROOM: ${d.roomCode}`;
                document.getElementById('host-start-btn').style.display = 'block';
                document.getElementById('wait-msg').style.display = 'none';
            }
        });

        // Chat & Voting Logs
        function sendChat() {
            const input = document.getElementById('chat-msg');
            if (input.value.trim()) {
                socket.emit('sendChat', input.value.trim());
                input.value = '';
            }
        }

        socket.on('chatMessage', d => {
            const h = document.getElementById('chat-history');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-msg';
            
            // Set custom color (for Green/Red voting logs)
            if (d.color) msgDiv.style.color = d.color;
            
            msgDiv.innerHTML = `<b>${d.user}:</b> ${d.msg}`;
            h.appendChild(msgDiv);
            h.scrollTop = h.scrollHeight;
        });

        // Player List Updates
        socket.on('updatePlayerList', data => {
            players = data;
            const listHtml = data.map(p => `<div class="player-tag ${p.isPres ? 'is-pres' : ''} ${!p.alive ? 'is-dead' : ''}">
                ${p.isPres ? 'ðŸ‘‘ ' : ''}${p.name} ${p.isLimit ? 'ðŸš«' : ''}
            </div>`).join('');
            document.getElementById('player-list').innerHTML = listHtml;
            document.getElementById('lobby-players').innerHTML = listHtml;
            
            if (amHost && data.length >= 5) {
                document.getElementById('host-start-btn').disabled = false;
            }
        });

        socket.on('gameStarted', () => {
            document.getElementById('setup-screen').style.display = 'none';
        });

        socket.on('assignRole', d => {
            window.myIdentity = d; // Store role and info
            document.getElementById('id-text').innerText = "Identity: [Hidden]";
        });

        function reveal(show) {
            if (!window.myIdentity) return;
            document.getElementById('id-text').innerText = show ? 
                `${window.myIdentity.role}\n${window.myIdentity.info}` : "Identity: [Hidden]";
        }

        // Game Board Updates
        socket.on('policyUpdated', d => {
            const ct = document.getElementById('construction-track'); ct.innerHTML = '';
            for(let i=1; i<=6; i++) {
                const filled = i <= d.enactedPolicies.construction;
                ct.innerHTML += `<div class="slot ${filled ? 'filled-construction' : ''}">${filled ? 'IU' : i}</div>`;
            }
            const tt = document.getElementById('tradition-track'); tt.innerHTML = '';
            for(let i=1; i<=5; i++) {
                const filled = i <= d.enactedPolicies.tradition;
                tt.innerHTML += `<div class="slot ${filled ? 'filled-tradition' : ''}">${filled ? 'PURDUE' : i}</div>`;
            }
        });

        // Presidential Rounds
        socket.on('newRound', d => {
            document.getElementById('status-bar').innerText = `Current President: ${d.presidentName}`;
            if (socket.id === d.presidentId) {
                document.getElementById('nomination-zone').style.display = 'block';
                const sel = document.getElementById('vp-select');
                sel.innerHTML = players.filter(p => p.alive && !p.isPres && !p.isLimit)
                                       .map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            } else {
                document.getElementById('nomination-zone').style.display = 'none';
            }
        });

        function nominate() {
            const vp = document.getElementById('vp-select').value;
            socket.emit('nominateVP', vp);
            document.getElementById('nomination-zone').style.display = 'none';
        }

        socket.on('startVoting', d => {
            document.getElementById('vote-prompt').innerText = `Elect President ${d.pres} & VP ${d.vp}?`;
            document.getElementById('vote-overlay').style.display = 'flex';
        });

        function castVote(v) {
            socket.emit('submitVote', v);
            document.getElementById('vote-overlay').style.display = 'none';
        }

        // Legislative Session
        socket.on('presDrawPhase', () => {
            document.getElementById('draw-btn').style.display = 'block';
        });

        socket.on('presDiscardPhase', cards => {
            document.getElementById('draw-btn').style.display = 'none';
            showPolicyInterface(cards, "President: Discard 1 Policy", true);
        });

        socket.on('vpEnactPhase', d => {
            showPolicyInterface(d.cards, "Vice President: Enact 1 Policy", false);
        });

        function showPolicyInterface(cards, prompt, isPres) {
            document.getElementById('policy-prompt').innerText = prompt;
            const container = document.getElementById('policy-choices');
            container.innerHTML = '';
            
            cards.forEach((type, index) => {
                const card = document.createElement('div');
                card.className = 'policy-card';
                card.style.background = type === 'Tradition' ? 'var(--p-gold)' : 'var(--iu-red)';
                card.style.color = type === 'Tradition' ? 'black' : 'white';
                card.innerText = type;
                card.onclick = () => {
                    document.getElementById('policy-overlay').style.display = 'none';
                    if (isPres) {
                        const remaining = [...cards];
                        remaining.splice(index, 1);
                        socket.emit('presDiscard', remaining);
                    } else {
                        socket.emit('vpEnact', type);
                    }
                };
                container.appendChild(card);
            });
            document.getElementById('policy-overlay').style.display = 'flex';
        }

        socket.on('errorMsg', m => alert(m));
        socket.on('gameOver', m => {
            alert("GAME OVER: " + m);
            location.reload();
        });
    </script>
</body>
</html>