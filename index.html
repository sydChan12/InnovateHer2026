<!DOCTYPE html>
<html>
<head>
    <title>Bell Tower Purdue Edition</title>
    <style>
        :root { --p-gold: #CEB888; --iu-red: #990000; --bg: #0b0b0b; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #setup-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .card { background: #111; padding: 30px; border: 2px solid var(--p-gold); border-radius: 8px; width: 320px; text-align: center; }
        input { padding: 12px; margin: 8px 0; width: 90%; background: #000; color: white; border: 1px solid #444; border-radius: 4px; }
        .btn { padding: 12px 20px; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; width: 100%; }
        .btn-gold { background: var(--p-gold); color: black; }
        #sidebar { width: 280px; background: #000; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #game-area { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .pile-container { display: flex; gap: 30px; margin-bottom: 20px; }
        .card-pile { width: 70px; height: 95px; border: 2px solid var(--p-gold); border-radius: 6px; display: flex; align-items: center; justify-content: center; background: #1a1a1a; }
        .tracker-row { display: flex; align-items: center; gap: 10px; margin: 10px 0; background: #111; padding: 10px; border-radius: 10px; }
        .chaos-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid #444; }
        .chaos-dot.active { background: var(--iu-red); }
        .track { display: flex; gap: 10px; margin: 15px 0; }
        .slot { width: 80px; height: 110px; border: 1px dashed #444; position: relative; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; text-align: center; }
        .filled-construction { background: var(--iu-red); }
        .filled-tradition { background: var(--p-gold); color: black; }
        #overlay, #vote-overlay, #policy-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .policy-card { width: 110px; height: 160px; margin: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="card" id="start-card">
            <h2 style="color:var(--p-gold)">THE BELL TOWER</h2>
            <input id="user-name" placeholder="Your Name">
            <button class="btn btn-gold" onclick="createRoom()">Create Room</button>
            <input id="join-code" placeholder="Room Code">
            <button class="btn" onclick="joinRoom()">Join Room</button>
        </div>
        <div class="card" id="lobby-card" style="display:none">
            <h3 id="room-display"></h3>
            <div id="lobby-players"></div>
            <button id="host-start-btn" class="btn btn-gold" style="display:none" onclick="socket.emit('startGame')">Start</button>
        </div>
    </div>

    <div id="sidebar">
        <div id="player-list" style="flex:1; padding:15px;"></div>
        <div id="chat-history" style="height:200px; background:#050505; overflow-y:auto;"></div>
        <div style="padding:15px; background:#111;">
            <p id="id-text" style="font-size:0.7rem; color:#888;">Identity: [Hidden]</p>
            <button class="btn btn-gold" onmousedown="reveal(true)" onmouseup="reveal(false)">REVEAL</button>
        </div>
    </div>

    <div id="game-area">
        <div id="status">Lobby</div>
        <div class="pile-container">
            <div class="card-pile"><span id="deck-count">0</span></div>
            <div class="card-pile" style="border-color:#444"><span id="discard-count">0</span></div>
        </div>
        <div class="tracker-row">
            <div id="dot-1" class="chaos-dot"></div><div id="dot-2" class="chaos-dot"></div><div id="dot-3" class="chaos-dot"></div>
        </div>
        <div class="track" id="tradition-track"></div>
        <div class="track" id="construction-track"></div>
        <div id="nom-zone" style="display:none">
            <select id="vp-sel"></select><button class="btn btn-gold" onclick="nominate()">Nominate</button>
        </div>
        <button id="draw-btn" class="btn btn-gold" style="display:none" onclick="socket.emit('drawThree')">Draw 3</button>
    </div>

    <div id="vote-overlay">
        <h2 id="v-prompt"></h2>
        <button class="btn btn-gold" onclick="cast('Boiler Up!')">YES</button>
        <button class="btn" onclick="cast('Hammer Down!')">NO</button>
    </div>

    <div id="policy-overlay"><h2 id="p-prompt"></h2><div id="p-choices" style="display:flex"></div></div>
    <div id="overlay"><h2 id="o-title"></h2><div id="o-content"></div></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let players = [], currentHand = [], constructionCount = 0;

        function createRoom() { socket.emit('createRoom', document.getElementById('user-name').value); }
        function joinRoom() { socket.emit('joinRoom', { roomCode: document.getElementById('join-code').value, userName: document.getElementById('user-name').value }); }
        function reveal(s) { document.getElementById('id-text').innerText = s ? `${window.roleData.role}\n${window.roleData.info}` : "Identity: [Hidden]"; }
        function nominate() { socket.emit('nominateVP', document.getElementById('vp-sel').value); document.getElementById('nom-zone').style.display='none'; }
        function cast(v) { socket.emit('submitVote', v); document.getElementById('vote-overlay').style.display='none'; }

        socket.on('joinedRoom', d => {
            document.getElementById('setup-screen').style.display='none';
            document.getElementById('room-display').innerText = d.roomCode;
            if(d.isHost) document.getElementById('host-start-btn').style.display='block';
        });

        socket.on('updatePlayerList', data => {
            players = data;
            document.getElementById('player-list').innerHTML = data.map(p => `<div>${p.name} ${p.isPres?'ðŸ‘‘':''} ${p.isLimit?'ðŸš«':''}</div>`).join('');
        });

        socket.on('policyUpdated', d => {
            constructionCount = d.enactedPolicies.construction;
            const ct = document.getElementById('construction-track'); ct.innerHTML = '';
            for(let i=1; i<=6; i++) ct.innerHTML += `<div class="slot ${i<=d.enactedPolicies.construction?'filled-construction':''}">IU</div>`;
            const tt = document.getElementById('tradition-track'); tt.innerHTML = '';
            for(let i=1; i<=5; i++) tt.innerHTML += `<div class="slot ${i<=d.enactedPolicies.tradition?'filled-tradition':''}">PURDUE</div>`;
        });

        socket.on('newRound', d => {
            if(socket.id === d.presidentId) {
                document.getElementById('nom-zone').style.display='block';
                document.getElementById('vp-sel').innerHTML = players.filter(p => p.name !== d.presidentName && p.alive && !p.isLimit).map(p => `<option>${p.name}</option>`).join('');
            }
        });

        socket.on('vpEnactPhase', data => {
            currentHand = data.cards;
            const container = document.getElementById('p-choices'); container.innerHTML = '';
            currentHand.forEach((c, i) => {
                const div = document.createElement('div'); div.className = 'policy-card';
                div.style.background = c === 'Tradition' ? 'var(--p-gold)' : 'var(--iu-red)';
                div.innerText = c;
                div.onclick = () => { socket.emit('vpEnact', {enacted: c, discarded: currentHand[1-i]}); document.getElementById('policy-overlay').style.display='none'; };
                container.appendChild(div);
            });
            if(constructionCount >= 5) {
                const vBtn = document.createElement('button'); vBtn.innerText = "VETO"; vBtn.onclick = () => socket.emit('requestVeto'); container.appendChild(vBtn);
            }
            document.getElementById('policy-overlay').style.display='flex';
        });

        socket.on('vetoRequested', () => {
            document.getElementById('o-title').innerText = "Veto?";
            document.getElementById('o-content').innerHTML = `<button onclick="socket.emit('vetoResponse', true); document.getElementById('overlay').style.display='none'">Agree</button><button onclick="socket.emit('vetoResponse', false); document.getElementById('overlay').style.display='none'">Deny</button>`;
            document.getElementById('overlay').style.display='flex';
        });

        socket.on('triggerExpel', () => {
            document.getElementById('o-title').innerText = "EXPEL";
            let ops = players.filter(p => p.alive).map(p => `<option>${p.name}</option>`).join('');
            document.getElementById('o-content').innerHTML = `<select id="ex-s">${ops}</select><button onclick="socket.emit('powerExpel', document.getElementById('ex-s').value); document.getElementById('overlay').style.display='none'">EXPEL</button>`;
            document.getElementById('overlay').style.display='flex';
        });

        socket.on('assignRole', d => window.roleData = d);
        socket.on('presDrawPhase', () => document.getElementById('draw-btn').style.display='block');
        socket.on('presDiscardPhase', hand => {
            document.getElementById('draw-btn').style.display='none';
            currentHand = hand;
            const container = document.getElementById('p-choices'); container.innerHTML = '';
            hand.forEach((c, i) => {
                const div = document.createElement('div'); div.className = 'policy-card';
                div.style.background = c === 'Tradition' ? 'var(--p-gold)' : 'var(--iu-red)';
                div.innerText = c;
                div.onclick = () => { 
                    let kept = [...currentHand]; let disc = kept.splice(i, 1)[0];
                    socket.emit('presDiscard', {kept, discarded: disc}); 
                    document.getElementById('policy-overlay').style.display='none'; 
                };
                container.appendChild(div);
            });
            document.getElementById('policy-overlay').style.display='flex';
        });
        socket.on('updateCounts', d => { document.getElementById('deck-count').innerText = d.deckCount; document.getElementById('discard-count').innerText = d.discardCount; });
        socket.on('gameStarted', () => document.getElementById('setup-screen').style.display='none');
        socket.on('startVoting', d => { document.getElementById('v-prompt').innerText = `Elect ${d.vp}?`; document.getElementById('vote-overlay').style.display='flex'; });
    </script>
</body>
</html>