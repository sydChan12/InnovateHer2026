<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Under the Bell Tower | Purdue Edition</title>
    <style>
        :root { --p-gold: #CEB888; --p-black: #000000; --iu-red: #990000; --bg: #0b0b0b; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--p-gold); }

        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR FIX: Using flex-direction column with fixed identity area at bottom */
        #sidebar { 
            width: 300px; 
            background: #000; 
            border-right: 2px solid var(--p-gold); 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
        }

        #sidebar-header { padding: 15px 15px 5px 15px; flex-shrink: 0; }
        
        #player-list { 
            flex: 0 1 auto; /* Allow it to grow but also shrink */
            overflow-y: auto; 
            padding: 0 15px;
            max-height: 35%; /* Caps the player list height */
        }
        
        #chat-container { 
            flex: 1; /* Chat takes up the remaining middle space */
            display: flex; 
            flex-direction: column; 
            background: #050505; 
            margin: 10px 15px;
            border: 1px solid #222;
            min-height: 150px;
        }

        #chat-history { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.85rem; }
        
        #identity-area { 
            flex-shrink: 0; /* Never allow this area to be squished */
            padding: 15px; 
            background: #111;
            border-top: 2px solid var(--p-gold);
        }

        /* Lobby */
        #lobby-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .setup-card { background: #1a1a1a; padding: 40px; border-radius: 8px; border: 2px solid var(--p-gold); text-align: center; }

        /* Game Area */
        #game-area { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; gap: 20px; }
        .track-container { background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px; width: 95%; max-width: 800px; text-align: center; border: 1px solid #222; }
        .track { display: flex; gap: 8px; justify-content: center; margin-top: 10px; }
        .slot { width: 80px; height: 110px; border: 1px dashed #444; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; }
        .slot.filled-tradition { background: var(--p-gold); color: black; border-style: solid; }
        .slot.filled-construction { background: var(--iu-red); color: white; border-style: solid; }

        .player-item { background: #151515; margin: 4px 0; padding: 8px; border-radius: 4px; border-left: 4px solid #333; font-size: 0.85rem; position: relative; }
        .player-item.is-pres { border-left-color: var(--p-gold); }
        .badge-pres { position: absolute; right: 5px; top: 8px; background: var(--p-gold); color: black; font-size: 0.6rem; padding: 2px 4px; border-radius: 2px; }

        #status-bar { background: #1a1a1a; color: var(--p-gold); padding: 10px 25px; border-radius: 20px; border: 1px solid var(--p-gold); font-weight: bold; }
        #nomination-zone { display: none; padding: 15px; background: #1a1a1a; border-radius: 8px; border: 1px solid #333; }
        
        #vote-overlay, #policy-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-gold { background: var(--p-gold); color: black; }
        .policy-card { width: 120px; height: 170px; margin: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="lobby-screen">
        <div class="setup-card">
            <h1 style="color: var(--p-gold);">ðŸ”” UNDER THE BELL TOWER</h1>
            <div id="join-controls">
                <input id="username" placeholder="Student Name" style="padding: 10px; background: #000; border: 1px solid #444; color: white;">
                <button class="btn btn-gold" onclick="joinGame()">Enter</button>
            </div>
            <div id="lobby-waiting" style="display: none;">
                <div id="lobby-list" style="margin: 20px 0;"></div>
                <button class="btn btn-gold" onclick="startGame()">Start Semester</button>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div id="sidebar-header">
            <h4 style="color: var(--p-gold); margin: 0;">CAMPUS DIRECTORY</h4>
        </div>
        
        <div id="player-list"></div>
        
        <div id="chat-container">
            <div id="chat-history"></div>
            <div style="display: flex; border-top: 1px solid #222;">
                <input id="chat-msg" placeholder="Debate..." style="flex:1; background:transparent; border:none; color:white; padding:10px; outline:none;" onkeydown="if(event.key==='Enter') sendChat()">
            </div>
        </div>

        <div id="identity-area">
            <p id="role-display" style="font-size: 0.8rem; color: #888; margin-top:0;">Identity: [Hidden]</p>
            <button class="btn btn-gold" style="width: 100%;" onmousedown="revealRole()" onmouseup="hideRole()" ontouchstart="revealRole()" ontouchend="hideRole()">Hold to Reveal</button>
        </div>
    </div>

    <div id="game-area">
        <div id="status-bar">Waiting...</div>

        <div class="track-container">
            <h5 style="margin:0">TRADITION TRACK</h5>
            <div class="track" id="tradition-track"></div>
        </div>

        <div class="track-container">
            <h5 style="margin:0">CONSTRUCTION TRACK</h5>
            <div class="track" id="construction-track"></div>
            <small>Tracker: <span id="tracker-val">0</span>/3</small>
        </div>

        <div id="nomination-zone">
            <input id="vp-input" placeholder="Nominate VP" style="padding: 8px; background: #000; border: 1px solid #444; color: white;">
            <button class="btn btn-gold" onclick="nominate()">Confirm</button>
        </div>

        <button id="draw-btn" class="btn btn-gold" style="display: none; padding: 15px 30px;" onclick="drawPolicies()">Draw 3 Cards</button>
    </div>

    <div id="vote-overlay">
        <h2 id="vote-prompt">ELECT?</h2>
        <div style="display: flex; gap: 20px;">
            <button class="btn btn-gold" onclick="castVote('Boiler Up!')" style="padding: 30px;">ðŸš‚ BOILER UP!</button>
            <button onclick="castVote('Hammer Down!')" style="background: var(--iu-red); color: white; padding: 30px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">ðŸ”¨ HAMMER DOWN!</button>
        </div>
    </div>

    <div id="policy-overlay">
        <h2 id="policy-prompt" style="color: var(--p-gold);">LEGISLATIVE SESSION</h2>
        <div id="policy-choices" style="display: flex;"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRole = "", myParty = "";

        function sendChat() {
            const input = document.getElementById('chat-msg');
            if (input.value.trim()) { socket.emit('sendChat', input.value.trim()); input.value = ''; }
        }

        socket.on('chatMessage', (data) => {
            const history = document.getElementById('chat-history');
            history.innerHTML += `<div><span style="color:var(--p-gold)">${data.user}:</span> ${data.msg}</div>`;
            history.scrollTop = history.scrollHeight;
        });

        function joinGame() {
            const name = document.getElementById('username').value.trim();
            if (name) {
                socket.emit('joinGame', name);
                document.getElementById('join-controls').style.display = 'none';
                document.getElementById('lobby-waiting').style.display = 'block';
            }
        }

        function startGame() { socket.emit('startGame'); }

        socket.on('updatePlayerList', (data) => {
            const html = data.map(p => `
                <div class="player-item ${p.isPres ? 'is-pres' : ''}">
                    ${p.name} ${p.isPres ? '<span class="badge-pres">PRES</span>' : ''}
                </div>`).join('');
            document.getElementById('player-list').innerHTML = html;
            document.getElementById('lobby-list').innerHTML = html;
        });

        socket.on('gameStarted', () => { document.getElementById('lobby-screen').style.display = 'none'; });
        socket.on('assignRole', (data) => { myRole = data.role; myParty = data.party; });
        
        function revealRole() {
            const d = document.getElementById('role-display');
            d.innerText = `Identity: ${myRole}`;
            d.style.color = myParty === 'Liberal' ? 'var(--p-gold)' : 'var(--iu-red)';
        }
        function hideRole() {
            document.getElementById('role-display').innerText = `Identity: [Hidden]`;
            document.getElementById('role-display').style.color = '#888';
        }

        socket.on('newRound', (data) => {
            document.getElementById('nomination-zone').style.display = socket.id === data.presidentId ? 'block' : 'none';
            document.getElementById('status-bar').innerText = socket.id === data.presidentId ? "YOUR TURN: Nominate VP" : `President ${data.presidentName} is nominating...`;
        });

        function nominate() {
            const vp = document.getElementById('vp-input').value.trim();
            if (vp) socket.emit('nominateVP', vp);
        }

        socket.on('startVoting', (data) => {
            document.getElementById('vote-prompt').innerText = `Elect ${data.pres} & ${data.vp}?`;
            document.getElementById('vote-overlay').style.display = 'flex';
        });

        function castVote(c) { socket.emit('submitVote', c); document.getElementById('vote-overlay').style.display = 'none'; }
        socket.on('presDrawPhase', () => { document.getElementById('draw-btn').style.display = 'block'; });
        function drawPolicies() { socket.emit('drawThree'); document.getElementById('draw-btn').style.display = 'none'; }
        socket.on('presDiscardPhase', (hand) => { showPolicyOverlay(hand, "PRESIDENT: Discard 1", true); });
        socket.on('vpEnactPhase', (hand) => { showPolicyOverlay(hand, "VICE PRESIDENT: Enact 1", false); });

        function showPolicyOverlay(cards, prompt, isPres) {
            document.getElementById('policy-prompt').innerText = prompt;
            const container = document.getElementById('policy-choices');
            container.innerHTML = '';
            cards.forEach((card, index) => {
                const div = document.createElement('div');
                div.className = 'policy-card';
                div.style.backgroundColor = card === 'Tradition' ? 'var(--p-gold)' : 'var(--iu-red)';
                div.style.color = card === 'Tradition' ? 'black' : 'white';
                div.innerText = card;
                div.onclick = () => {
                    document.getElementById('policy-overlay').style.display = 'none';
                    if (isPres) {
                        let rem = [...cards]; rem.splice(index, 1);
                        socket.emit('presDiscard', rem);
                    } else {
                        socket.emit('vpEnact', card);
                    }
                };
                container.appendChild(div);
            });
            document.getElementById('policy-overlay').style.display = 'flex';
        }

        socket.on('policyUpdated', (data) => {
            const tt = document.getElementById('tradition-track');
            const ct = document.getElementById('construction-track');
            tt.innerHTML = ''; ct.innerHTML = '';
            for(let i=0; i<5; i++) tt.innerHTML += `<div class="slot ${i < data.enactedPolicies.tradition ? 'filled-tradition' : ''}">${i < data.enactedPolicies.tradition ? 'BOILER' : i+1}</div>`;
            for(let i=0; i<6; i++) ct.innerHTML += `<div class="slot ${i < data.enactedPolicies.construction ? 'filled-construction' : ''}">${i < data.enactedPolicies.construction ? 'HOOSIER' : i+1}</div>`;
            document.getElementById('tracker-val').innerText = data.electionTracker;
        });

        socket.on('gameOver', (m) => { alert(m); location.reload(); });
        socket.on('errorMsg', (m) => alert(m));
    </script>
</body>
</html>